name: Release and Publish

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      create_tag:
        description: 'Create a git tag for this version'
        required: false
        default: true
        type: boolean

permissions:
  id-token: write  
  contents: write
  packages: write

jobs:
  # Run if it's a tag push to main or manual workflow dispatch
  check-context:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: Check if should run
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]] && [[ "${{ github.ref_name }}" == v*.*.* ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract version
        id: extract
        if: steps.check.outputs.should_run == 'true'
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

  build-and-publish:
    needs: check-context
    if: needs.check-context.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Create git tag (manual workflow)
        if: github.event_name == 'workflow_dispatch' && inputs.create_tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.check-context.outputs.version }}" -m "Release v${{ needs.check-context.outputs.version }}"
          git push origin "v${{ needs.check-context.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run type checking
        run: bun run typecheck

      - name: Run tests
        run: bun test

      - name: Build CLI
        run: bun run build.ts

      - name: Verify build artifacts
        run: |
          echo "Checking for build artifacts..."
          ls -la dist/
          test -f dist/index.js || (echo "dist/index.js not found" && exit 1)
          test -f dist/linux-x64/databasin || (echo "Linux binary not found" && exit 1)
          test -f dist/darwin-arm64/databasin || (echo "macOS ARM64 binary not found" && exit 1)
          test -f dist/darwin-x64/databasin || (echo "macOS x64 binary not found" && exit 1)
          test -f dist/build-info.json || (echo "build-info.json not found" && exit 1)
          echo "All build artifacts verified âœ“"

      - name: Setup Node.js for npm publish
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm
        run: npm install -g npm@latest
      
      - name: Prepare npm package
        run: |
          # Use concise README for npm (full docs on GitHub)
          echo "Swapping README for npm package..."
          rm -f README.md
          mv .github/README.npm.md README.md
          echo "README prepared for npm âœ“"

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Extract release notes
        id: release_notes
        run: |
          VERSION=${{ needs.check-context.outputs.version }}
          echo "Extracting release notes for version $VERSION"

          # Start with installation section
          cat > release_notes.txt << 'INSTALL_EOF'
          ## Installation

          ### Option 1: Standalone Binary (No Runtime Required)
          Download the binary for your platform from the assets below and add to your PATH with a single command:

          `curl -fsSL https://raw.githubusercontent.com/Databasin-AI/databasin-cli/main/install.sh | bash`

          ### Option 2: npm/npx (Requires Node.js 20+ or Bun 1.3+)
          ```bash
          # Install globally
          npm install -g @databasin/cli

          # Or run directly with npx
          npx @databasin/cli --help
          ```

          ðŸ“¦ **npm package:** https://www.npmjs.com/package/@databasin/cli

          ---

          INSTALL_EOF

          # Try to extract from CHANGELOG.md if it exists
          if [ -f CHANGELOG.md ]; then
            # Extract the section for this version
            NOTES=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '1d;$d' | sed '/^$/d')

            if [ -z "$NOTES" ]; then
              # Fallback: try without brackets
              NOTES=$(sed -n "/## ${VERSION}/,/## /p" CHANGELOG.md | sed '1d;$d' | sed '/^$/d')
            fi

            if [ -n "$NOTES" ]; then
              echo "Found release notes in CHANGELOG.md"
              echo "## Changes" >> release_notes.txt
              echo "" >> release_notes.txt
              echo "$NOTES" >> release_notes.txt
            else
              echo "" >> release_notes.txt
              echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release_notes.txt
            fi
          else
            echo "## Build Info" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "- TypeScript compilation" >> release_notes.txt
            echo "- Multi-platform executables (Linux x64, macOS ARM64, macOS x64)" >> release_notes.txt
            echo "- Node.js compatible bundle for npm" >> release_notes.txt
          fi

      - name: Rename binaries for release
        run: |
          # Rename binaries to include platform to avoid GitHub Release asset name conflicts
          mv dist/linux-x64/databasin dist/databasin-linux-x64
          mv dist/darwin-arm64/databasin dist/databasin-darwin-arm64
          mv dist/darwin-x64/databasin dist/databasin-darwin-x64
          echo "Renamed binaries for release upload âœ“"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-context.outputs.version }}
          name: Release v${{ needs.check-context.outputs.version }}
          body_path: release_notes.txt
          draft: false
          prerelease: false
          files: |
            dist/index.js
            dist/databasin-linux-x64
            dist/databasin-darwin-arm64
            dist/databasin-darwin-x64
            dist/build-info.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Version: ${{ needs.check-context.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Published to npm: [@databasin/cli@${{ needs.check-context.outputs.version }}](https://www.npmjs.com/package/@databasin/cli)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… GitHub Release created: v${{ needs.check-context.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "- **npm:** \`npm install -g @databasin/cli\` (requires Node.js 18+ or Bun 1.0+)" >> $GITHUB_STEP_SUMMARY
          echo "- **Binary:** Download standalone executable below (no runtime required)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- \`index.js\` - Node.js compatible bundle (works with Node.js and Bun)" >> $GITHUB_STEP_SUMMARY
          echo "- \`databasin-linux-x64\` - Linux x64 standalone executable" >> $GITHUB_STEP_SUMMARY
          echo "- \`databasin-darwin-arm64\` - macOS ARM64 standalone executable" >> $GITHUB_STEP_SUMMARY
          echo "- \`databasin-darwin-x64\` - macOS x64 standalone executable" >> $GITHUB_STEP_SUMMARY
          echo "- \`build-info.json\` - Build metadata" >> $GITHUB_STEP_SUMMARY
